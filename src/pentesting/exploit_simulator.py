# src/pentesting/exploit_simulator.py
from typing import Dict
import time
import requests

# visible but harmless user agent
UA = "ExploitSim/1.0"

_DEFAULT_TIMEOUT = 3.0
_MAX_SNIPPET = 500


def _truncate(s: str, limit: int = _MAX_SNIPPET) -> str:
    # cap long responses in reports
    return s if len(s) <= limit else s[:limit] + "..."


def _now_ms() -> float:
    # millisecond clock for timings
    return time.time() * 1000.0


def simulate_reflected_xss(
    target_url: str,
    param: str = "q",
    marker: str = "<LABMARKER>",
    timeout: float = _DEFAULT_TIMEOUT
) -> Dict:
    # probe for reflected input using a safe marker
    started = _now_ms()
    session = requests.Session()
    session.headers.update({"User-Agent": UA})

    try:
        r = session.get(target_url, params={param: marker}, timeout=timeout)
        body = r.text or ""

        reflected = marker in body
        snippet = ""
        confidence = 0.1

        if reflected:
            idx = body.find(marker)
            s = max(0, idx - 80)
            e = min(len(body), idx + len(marker) + 80)
            snippet = _truncate(body[s:e])
            confidence = 0.9

        return {
            "target": target_url,
            "test": "reflected_xss",
            "status": getattr(r, "status_code", None),
            "success": reflected,
            "confidence": confidence,
            "evidence": {
                "param": param,
                "marker": marker,
                "content_type": r.headers.get("Content-Type"),
                "snippet": snippet,
            },
            "time_ms": round(_now_ms() - started, 1),
        }

    except Exception as e:
        return {
            "target": target_url,
            "test": "reflected_xss",
            "error": str(e),
            "success": False,
            "confidence": 0.0,
            "time_ms": round(_now_ms() - started, 1),
        }


def simulate_insecure_update(
    target_url: str,
    timeout: float = _DEFAULT_TIMEOUT
) -> Dict:
    # look for update metadata that hints at unsigned firmware
    started = _now_ms()
    session = requests.Session()
    session.headers.update({"User-Agent": UA})

    try:
        url = target_url.rstrip("/") + "/.well-known/firmware"
        r = session.get(url, timeout=timeout)
        body = r.text or ""

        out: Dict = {
            "target": target_url,
            "test": "insecure_update",
            "status": getattr(r, "status_code", None),
            "success": False,
            "confidence": 0.0,
            "evidence": {},
            "time_ms": round(_now_ms() - started, 1),
        }

        try:
            # treat JSON as metadata, not a payload
            j = r.json()
            out["evidence"]["json_summary"] = {
                k: j.get(k) for k in ("latest", "signed") if k in j
            }
            out["evidence"]["body_len"] = len(body)

            if j.get("signed") is False:
                out["success"] = True
                out["confidence"] = 0.85
                out["evidence"]["issue"] = "unsigned_firmware_advertised"
            else:
                out["confidence"] = 0.2

        except ValueError:
            # non-JSON still gives a faint signal
            out["evidence"]["content_type"] = r.headers.get("Content-Type")
            out["evidence"]["snippet"] = _truncate(body)
            out["confidence"] = 0.05

        return out

    except Exception as e:
        return {
            "target": target_url,
            "test": "insecure_update",
            "error": str(e),
            "success": False,
            "confidence": 0.0,
            "time_ms": round(_now_ms() - started, 1),
        }
