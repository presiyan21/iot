# tests/test_exploit_sim.py

import threading
import time
import socket
from http.server import BaseHTTPRequestHandler, HTTPServer

import pytest

from src.pentesting.exploit_simulator import (
    simulate_reflected_xss,
    simulate_insecure_update,
)
from src.pentesting.brute_force import brute_force_http_login


def _get_free_port() -> int:
    # Reserve a local port for the test server
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
        s.bind(("127.0.0.1", 0))
        return s.getsockname()[1]


class _SimDeviceHandler(BaseHTTPRequestHandler):
    # Simulated IoT device

    def do_GET(self):
        if self.path.startswith("/search"):
            body = f"<html>{self.path}</html>".encode()
            self.send_response(200)
            self.send_header("Content-Type", "text/html")
            self.send_header("Content-Length", str(len(body)))
            self.end_headers()
            self.wfile.write(body)
            return

        if self.path.startswith("/.well-known/firmware"):
            body = b'{"latest":"1.0.1","signed":false}'
            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.end_headers()
            self.wfile.write(body)
            return

        self.send_response(404)
        self.end_headers()

    def do_POST(self):
        if self.path == "/login":
            self.send_response(200)
            self.end_headers()
            self.wfile.write(b"Welcome admin")
            return

        self.send_response(404)
        self.end_headers()

    def log_message(self, *_):
        # Silence server logs during tests
        return


@pytest.fixture
def sim_device():
    port = _get_free_port()
    server = HTTPServer(("127.0.0.1", port), _SimDeviceHandler)
    thread = threading.Thread(target=server.serve_forever, daemon=True)
    thread.start()

    time.sleep(0.1)  # allow server to start
    yield f"http://127.0.0.1:{port}"

    server.shutdown()
    thread.join(timeout=1)


def test_exploit_simulation(sim_device):
    # Reflected XSS check
    xss = simulate_reflected_xss(f"{sim_device}/search")

    # Brute-force login check
    brute = brute_force_http_login(
        f"{sim_device}/login",
        username="admin",
        passwords=["admin"],
        stop_on_success=True,
    )

    assert xss["test"] == "reflected_xss"
    assert isinstance(xss["success"], bool)
    assert xss["confidence"] >= 0.1

    assert brute["test"] == "brute_force_login"
    assert brute["success_count"] == 1
    assert brute["stopped_early"] is True


def test_insecure_firmware_update_detection(sim_device):
    # Detect unsigned firmware metadata
    res = simulate_insecure_update(sim_device)

    assert res["test"] == "insecure_update"
    assert res["success"] is True
    assert res["confidence"] >= 0.8
    assert res["evidence"].get("issue") == "unsigned_firmware_advertised"
